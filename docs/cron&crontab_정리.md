# Cron & Crontab

## Cron
- 유닉스 계열에서 설정한 시간 사용자가 설정한 작업을 실행하게 해주는 작업스케줄

## Crontab
- cron에서 실행할 스케줄 기록해둔 파일

## Crontab 파일 위치
- `/var/spool/cron`
  - 사용자별로 crontab 파일이 생성되어 관리됨
  - `crontab` 명령어를 사용하여 관리 (파일 직접 수정하면 안됨!)
- `/etc/crontab`
  - 관리자(root)가 직접 지정한 작업 스케줄
  - 스케줄 정의할 때 사용자 지정 가능
  - 주로 시스템 관련 작업 등록
- `/etc/cron.d`
  - 소프트웨어 패키지 설치 시 필요한 작업 스케줄 등록
- `/etc/cron.allow`
  - 파일이 존재할 경우, 이 파일 내에 지정된 사용자만 crontab 명령 실행 가능
- `/etc/cron.deny`
  - `cron.allow`파일이 존재하지 않고, 이 파일이 존재할 경우
    <br>이 파일 내 지정된 사용자는 crontab 명령 실행 불가

> 위의 설명을 읽어보면 `crontab`명령어를 통해 생성한 cron과
> <br>`/etc/crontab`파일을 수정해서 설정한 cron의 차이를 알 수 있다.

> `crontab`명령어를 통해 생성한 cron은 사용자 별로 정의한 작업스케줄이기 때문에
> <br>사용자별로 crontab 파일이 생성되며 하나의 crontab 파일에는 한 사용자에 대한 작업스케줄만 기록되어있다.

> 반면 `/etc/crontab`파일을 수정해서 설정한 cron은 관리자(root) 계정으로 지정한 작업스케줄로
> <br>작업스케줄 마다 사용자를 다르게 지정할 수 있어 하나의 파일 안에 여러 사용자의 작업스케줄이 정의되어있다.

## cron 시작/중지/재시작
- 시작 : service cron start
- 중지 : service cron stop
- 재시작 : service cron restart 또는 service crond restart

## cron 구동 확인
- service cron status
- ps -ef | grep crond

## crontab 백업
- crontab을 잘 못 수정하거나 삭제한 경우 복구할 수 있도록 백업해두는 것이 좋다!
- crontab에 아래와 같이 작업을 등록한다 (실행 주기는 알아서 설정)
```
0 0 * * * crontab -l > /절대경로/백업파일명
```

## crontab 명령어
- `crontab -e` : 등록 (에디터 사용해서 crontab파일 편집 후 저장)
- `crontab -l` : 작업 목록
- `crontab -r` : 모든 작업 삭제 `!주의`
- `crontab -u 사용자명 [옵션]` : 해당 사용자의 crontab 조회(`-l`)/편집(`-e`)/삭제(`-r`)

## cron 스케줄 작성
> m h dom mon dow (user) command
> <br>`!주의` 한줄에 하나의 명령만 작성한다
- m : 분 minute
- h : 시간 hour
- dom : 일 day of month
- mon : 월 month
- dow : 요일 day of week (0-7)(0:일, 1-6:월-토, 7:일)


- `*` 단위마다 반복 (매분, 매시간, 매일, 매월, 매요일)
- `값1-값2` 값1 ~ 값2 동안 실행
- `값1,값2,값3,...` 입력한 값에 실행
- `*/값` 입력한 값 마다 실행

<br>

매분 test.sh 실행
```
* * * * * /절대경로/파일명.sh
```
<br>

매 10분마다 실행
```
*/10 * * * * /절대경로/파일명.sh
```
<br>

매주 월요일 오전 6시 0분에 실행
```
0 6 * * 1 /절대경로/파일명.sh
```
<br>

매일 매시간 0분, 15분, 30분, 45분에 실행
```
0,15,30,45 * * * * /절대경로/파일명.sh
```
<br>

매일 5시 10분부터 20분까지 매분 실행
```
10-20 5 * * * /절대경로/파일명.sh
```
<br>

1일에서 5일까지 1시,2시,3시에 매 15분마다 실행
```
*/15 1,2,3 1-5 * * /절대경로/파일명.sh
```

## cron 로그 남기기
매번 작업 실행 시 로그 새로 기록 (덮어쓰기)
> cron명령 > /절대경로/로그파일명

덮어쓰지 않고 추가
> cron명령 >> /절대경로/로그파일명

로그 남기지 않음
> cron명령 > /dev/null 2>&1

※ 오류도 함께 기록하려면 뒤에 2>&1 추가
<br>
※ `/dev/null`에 대해서는 아래 번외 내용 참고

<br>

---
### (번외)
## bash 리다이렉션 명령
> 표준 입력, 표준 출력, 표준 에러를 변경해주는 명령

`<` : 입력 리다이렉션

`>` : 출력/오류 리다이렉션

`&>`, `>&` : 출력&오류 모두 리다이렉션

- 명령기호 앞 : 리다이렉션해줄 파일 디스크립터
- 명령기호 뒤 : 바꿀 파일 디스크립터


- 파일 디스크립터
  - 0 : 표준 입력
  - 1 : 표준 출력
  - 2 : 표준 에러


- 출력 리다이렉션 시, 리다이렉션 대상을 적지 않으면 1 즉 표준출력을 적은 것으로 본다


- `&>`, `>&` 차이점
  - `&>`는 뒤에 파일명만 지정할 수 있다 (숫자가 와도 파일디스크립터를 의미하는게 아닌, 파일명을 의미)
  - `>&`는 뒤에 파일명, 파일디스크립터 숫자 둘다 올 수 있다
  <br>단, 숫자가 오는 경우 무조건 파일디스크립터로 인식한다
  - `커맨드 &>1` : 결과, 오류 모두 '1'이라는 이름의 파일에 기록됨
  - `커맨드 >aaa.log >&1` : 결과, 오류 모두 표준 출력으로 출력됨 (표준출력 : aaa.log파일)


- `>` 뒤에 파일디스크립터를 쓸 수 없다
  - 때문에 파일디스크립터로 리다이렉트 하려면 `>&`을 사용해야한다
  - `커맨드 >aaa.log 2>&1` : 표준 출력은 aaa.log파일로 리다이렉트, 표준 오류는 표준 출력으로 리다이렉트
    <br>(즉, 표준 오류도 aaa.log파일에 기록된다)
  - `커맨드 >aaa.log 2>1` 이렇게 적으면 표준 오류가 '1'이라는 이름의 파일에 기록된다


## Bit Bucket ( `/dev/null` )
> 리눅스의 null 장치파일
> <br>주로 불필요한 출력 스트림을 버리는 곳으로 사용

- 아래와 같이 말하기도 함
  - black hole
  - null device
- 대용 장치파일 `/dev/zero`
  - null 문자를 무한 제공하는 리눅스 장치파일
  - `/dev/null`과 같이 출력 스트림을 버리는 데 활용 가능
  - 원하는 용량만큼 빈 값으로 파일 채우는 데 사용 가능


## `/dev/zero` 사용 예
null로 채워진 1MB짜리 파일 만들기
```shell
dd if=/dev/zero of=foobar count=1024 bs=1024
```
만들어진 파일 용량, 내용 확인
```shell
root:~# ls -h foobar
-rw-r--r-- 1 root root 1.0M Dec 12 07:05 foobar

root:~# cat foobar | xxd -i -l8
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
```